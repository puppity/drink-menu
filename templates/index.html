<!DOCTYPE html>
<html lang="th">
<head>
    <title>‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ä‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #6b7280; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Checkbox ‡πÉ‡∏´‡∏ç‡πà‡πÜ */
        .custom-checkbox { width: 28px; height: 28px; cursor: pointer; accent-color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 p-4 font-sans text-gray-800 pb-24"> <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden p-4 fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <div class="text-5xl mb-4">üí°</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</h3>
            <div class="text-gray-600 mb-6 text-sm leading-relaxed text-left bg-gray-50 p-4 rounded-xl border">
                <p class="mb-2"><b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1 (‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß):</b><br>‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û"</p>
                <hr class="border-gray-200 my-2">
                <p><b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2 (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ):</b><br>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ"</b> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô<br>‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
            </div>
            <button onclick="closeModal()" class="bg-blue-600 text-white w-full py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg active:scale-95 transition">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
            </button>
        </div>
    </div>

    <div class="max-w-xl mx-auto relative">
        <h1 class="text-2xl font-bold mb-4 text-center text-gray-800 pt-4">‚òï ‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</h1>

        <div class="flex border-b border-gray-200 mb-4 sticky top-0 bg-gray-50 z-20 pt-2 transition-all" id="topBar">
            <button onclick="switchTab('watermark')" id="btn-watermark" class="flex-1 pb-3 text-center transition tab-active">
                ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ
            </button>
            <button onclick="switchTab('clean')" id="btn-clean" class="flex-1 pb-3 text-center transition tab-inactive">
                ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ
            </button>
        </div>

        <div class="flex justify-between items-center mb-4">
            <input type="text" id="searchInput" onkeyup="filterImages()" 
                   placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." 
                   class="flex-1 p-2.5 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white mr-2">
            
            <button onclick="toggleSelectMode(true)" id="enableSelectBtn"
                    class="bg-gray-800 text-white px-4 py-2.5 rounded-xl font-bold text-sm shadow hover:bg-gray-900 active:scale-95 transition whitespace-nowrap">
                ‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ
            </button>
        </div>

        <div id="content-watermark">
            <div id="grid-watermark" class="grid grid-cols-2 gap-3 image-grid">
                {% for img in wm_images %}
                <div class="image-card bg-white p-2 rounded-xl shadow-sm border border-gray-100 relative group transition-all duration-300">
                    <div class="selection-overlay hidden absolute inset-0 bg-black bg-opacity-10 z-10 rounded-xl flex items-start justify-end p-2 cursor-pointer" onclick="toggleCheckbox(this)">
                        <input type="checkbox" value="{{ img['secure_url'] }}" 
                               data-name="{{ img['public_id'].split('/')[-1] }}"
                               onclick="event.stopPropagation(); updateCount();"
                               class="custom-checkbox img-checkbox rounded-full shadow-md border-2 border-white bg-white">
                    </div>

                    <img src="{{ img['secure_url'] }}" crossorigin="anonymous" class="w-full h-40 object-cover rounded-lg mb-2 bg-gray-200">
                    <p class="text-sm font-bold text-gray-800 truncate mb-1 name-label text-center">
                        {{ img['public_id'].split('/')[-1] }}
                    </p>
                    <a href="{{ img['secure_url'] }}" target="_blank" class="view-btn block w-full bg-blue-50 text-blue-600 text-center py-1.5 rounded-lg text-xs font-bold">
                        ‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="content-clean" class="hidden">
            <div id="grid-clean" class="grid grid-cols-2 gap-3 image-grid">
                {% for img in cl_images %}
                <div class="image-card bg-white p-2 rounded-xl shadow-sm border border-gray-100 relative group transition-all duration-300">
                    <div class="selection-overlay hidden absolute inset-0 bg-black bg-opacity-10 z-10 rounded-xl flex items-start justify-end p-2 cursor-pointer" onclick="toggleCheckbox(this)">
                        <input type="checkbox" value="{{ img['secure_url'] }}" 
                               data-name="{{ img['public_id'].split('/')[-1] }}"
                               onclick="event.stopPropagation(); updateCount();"
                               class="custom-checkbox img-checkbox rounded-full shadow-md border-2 border-white bg-white">
                    </div>

                    <img src="{{ img['secure_url'] }}" crossorigin="anonymous" class="w-full h-40 object-cover rounded-lg mb-2 bg-gray-200">
                    <p class="text-sm font-bold text-gray-800 truncate mb-1 name-label text-center">
                        {{ img['public_id'].split('/')[-1] }}
                    </p>
                    <a href="{{ img['secure_url'] }}" target="_blank" class="view-btn block w-full bg-green-50 text-green-600 text-center py-1.5 rounded-lg text-xs font-bold">
                        ‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="selectionBar" class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 z-40 hidden slide-up">
        <div class="max-w-xl mx-auto flex items-center justify-between gap-3">
            <button onclick="toggleSelectMode(false)" class="bg-gray-200 text-gray-700 px-5 py-3 rounded-xl font-bold w-1/3 hover:bg-gray-300">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="handleSaveImages()" id="actionBtn" class="bg-blue-600 text-white px-5 py-3 rounded-xl font-bold w-2/3 shadow-lg hover:bg-blue-700 active:scale-95 transition flex items-center justify-center gap-2">
                üì≤ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á <span id="count-badge" class="bg-white text-blue-600 text-xs px-2 py-0.5 rounded-full hidden">0</span>
            </button>
        </div>
        <div class="text-center mt-2">
            <label class="inline-flex items-center text-sm text-gray-500 font-medium">
                <input type="checkbox" id="selectAllBtn" onchange="toggleSelectAll()" class="w-4 h-4 mr-2 rounded text-blue-600">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
            </label>
        </div>
    </div>

    <script>
        window.onload = function() { document.getElementById('infoModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('infoModal').classList.add('hidden'); }

        let currentTab = 'watermark';
        let isSelectMode = false;

        // --- ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö ---
        function switchTab(tab) {
            currentTab = tab;
            // ‡∏ñ‡πâ‡∏≤‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏á‡∏á
            if(isSelectMode) toggleSelectMode(false);

            document.getElementById('content-watermark').classList.add('hidden');
            document.getElementById('content-clean').classList.add('hidden');
            document.getElementById('content-' + tab).classList.remove('hidden');
            
            document.getElementById('btn-watermark').className = "flex-1 pb-3 text-center transition " + (tab === 'watermark' ? 'tab-active' : 'tab-inactive');
            document.getElementById('btn-clean').className = "flex-1 pb-3 text-center transition " + (tab === 'clean' ? 'tab-active' : 'tab-inactive');
            
            filterImages(); 
        }

        function filterImages() {
            let input = document.getElementById('searchInput').value.toLowerCase();
            let activeGridId = currentTab === 'watermark' ? 'grid-watermark' : 'grid-clean';
            let cards = document.getElementById(activeGridId).getElementsByClassName('image-card');
            for (let i = 0; i < cards.length; i++) {
                let name = cards[i].querySelector('.name-label').innerText.toLowerCase();
                cards[i].style.display = name.includes(input) ? "" : "none";
            }
        }

        // --- üî• Logic ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
        function toggleSelectMode(enable) {
            isSelectMode = enable;
            const overlays = document.querySelectorAll('.selection-overlay');
            const viewBtns = document.querySelectorAll('.view-btn'); // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà
            const selectBar = document.getElementById('selectionBar');
            const enableBtn = document.getElementById('enableSelectBtn');

            if (enable) {
                // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÇ‡∏ä‡∏ß‡πå Checkbox, ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏≤‡∏£‡πå‡∏•‡πà‡∏≤‡∏á, ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                overlays.forEach(el => el.classList.remove('hidden'));
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏∞‡∏Å‡∏∞
                viewBtns.forEach(btn => btn.classList.add('opacity-50', 'pointer-events-none'));
                
                selectBar.classList.remove('hidden');
                enableBtn.classList.add('hidden');
                
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏ó‡πá‡∏ö
                const actionBtn = document.getElementById('actionBtn');
                if (currentTab === 'watermark') {
                    actionBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    actionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    actionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    actionBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            } else {
                // ‡∏≠‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏ã‡πà‡∏≠‡∏ô Checkbox, ‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏≤‡∏£‡πå‡∏•‡πà‡∏≤‡∏á, ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
                overlays.forEach(el => el.classList.add('hidden'));
                viewBtns.forEach(btn => btn.classList.remove('opacity-50', 'pointer-events-none'));
                
                selectBar.classList.add('hidden');
                enableBtn.classList.remove('hidden');
                uncheckAll();
            }
        }

        // ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡πÜ ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡πä‡∏Å‡πÑ‡∏î‡πâ
        function toggleCheckbox(overlay) {
            const checkbox = overlay.querySelector('input');
            checkbox.checked = !checkbox.checked;
            updateCount();
        }

        function getActiveCheckboxes() {
            let activeGridId = currentTab === 'watermark' ? 'grid-watermark' : 'grid-clean';
            return Array.from(document.getElementById(activeGridId).querySelectorAll('.img-checkbox'))
                        .filter(cb => cb.closest('.image-card').style.display !== 'none');
        }

        function toggleSelectAll() {
            const master = document.getElementById('selectAllBtn');
            getActiveCheckboxes().forEach(cb => cb.checked = master.checked);
            updateCount();
        }

        function uncheckAll() {
            document.querySelectorAll('.img-checkbox').forEach(cb => cb.checked = false);
            if(document.getElementById('selectAllBtn')) document.getElementById('selectAllBtn').checked = false;
            updateCount();
        }

        function updateCount() {
            const count = getActiveCheckboxes().filter(cb => cb.checked).length;
            const badge = document.getElementById('count-badge');
            
            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // --- üì≤ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå (Web Share API) ---
        async function handleSaveImages() {
            const checkboxes = getActiveCheckboxes();
            let targets = checkboxes.filter(cb => cb.checked);
            
            if (targets.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            const btn = document.getElementById('actionBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°...";

            try {
                const filesArray = [];
                for (let cb of targets) {
                    const url = cb.value;
                    const name = cb.getAttribute('data-name') + ".jpg";
                    const res = await fetch(url);
                    const blob = await res.blob();
                    const file = new File([blob], name, { type: "image/jpeg" });
                    filesArray.push(file);
                }

                if (navigator.canShare && navigator.canShare({ files: filesArray })) {
                    await navigator.share({
                        files: filesArray,
                        title: '‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏ô‡∏π',
                        text: '‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏£‡∏±‡∏ö'
                    });
                    // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                    toggleSelectMode(false);
                } else {
                    alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏£‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô ZIP ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô");
                    const zip = new JSZip();
                    filesArray.forEach(f => zip.file(f.name, f));
                    const content = await zip.generateAsync({type:"blob"});
                    const zipName = currentTab === 'watermark' ? 'Menu_Watermark.zip' : 'Menu_Original.zip';
                    saveAs(content, zipName);
                    toggleSelectMode(false);
                }

            } catch (error) {
                console.log("Error:", error);
                if (!error.message.includes('abort')) {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå");
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <title>‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ä‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta property="og:title" content="‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° - ‡∏ä‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£" />
    <meta property="og:description" content="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" />
    <meta property="og:image" content="https://res.cloudinary.com/dii8jq2zm/image/upload/v1769175027/616942917_884276064367610_2902772526457452481_n_so770k.jpg" />
    <meta property="og:type" content="website" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #6b7280; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .custom-checkbox { width: 28px; height: 28px; cursor: pointer; accent-color: #2563eb; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pulse-btn { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 font-sans text-gray-800 pb-32">

    <div id="tutorialSingle" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4 fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center relative">
            <button onclick="closeModal('tutorialSingle')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">‚úï</button>
            <div class="text-5xl mb-4">üëÜ</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</h3>
            <p class="text-gray-600 mb-6 text-sm">
                ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ <b>"‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ"</b><br>‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û" ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
            </p>
            <button onclick="closeModal('tutorialSingle')" class="bg-gray-800 text-white w-full py-3 rounded-xl font-bold hover:bg-gray-900 transition">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
        </div>
    </div>

    <div id="tutorialMulti" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4 fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center relative">
            <div class="text-5xl mb-4">‚òëÔ∏è</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</h3>
            <p class="text-gray-600 mb-6 text-sm">
                1. ‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£<br>
                2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>"‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"</b> ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>
                3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π <b>Save Images</b>
            </p>
            <button onclick="closeModal('tutorialMulti')" class="bg-blue-600 text-white w-full py-3 rounded-xl font-bold hover:bg-blue-700 transition">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢!</button>
        </div>
    </div>

    <div id="processingModal" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center hidden p-6 fade-in">
        <div id="stateLoading" class="text-center w-full max-w-sm">
            <div class="loader mb-6"></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</h3>
            <p class="text-gray-500 text-sm mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2 overflow-hidden">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-xs text-gray-400">0/0</p>
        </div>
        <div id="stateReady" class="text-center w-full max-w-sm hidden">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h3>
            <p class="text-gray-600 mb-8">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
            <button onclick="triggerShare()" class="w-full bg-green-500 text-white text-xl py-5 rounded-2xl font-bold shadow-xl pulse-btn hover:bg-green-600 transition transform active:scale-95">üì≤ ‡πÅ‡∏ï‡∏∞‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Save</button>
            <button onclick="closeProcessing()" class="mt-6 text-gray-400 text-sm underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto relative"> 
        <h1 class="text-2xl font-bold mb-4 text-center text-gray-800 pt-4">‚òï ‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏ô‡∏π</h1>

        <div class="flex border-b border-gray-200 mb-4 sticky top-0 bg-gray-50 z-20 pt-2 transition-all max-w-xl mx-auto" id="topBar">
            <button onclick="switchTab('watermark')" id="btn-watermark" class="flex-1 pb-3 text-center transition tab-active">‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ</button>
            <button onclick="switchTab('clean')" id="btn-clean" class="flex-1 pb-3 text-center transition tab-inactive">‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ</button>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-3">
            <input type="text" id="searchInput" onkeyup="filterImages()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." class="w-full md:w-1/3 p-3 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            
            <div id="pcControls" class="hidden gap-3 w-full md:w-auto">
                <button onclick="downloadZipCurrentTab()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow hover:bg-blue-700 transition flex items-center gap-2">
                    üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (ZIP)
                </button>
            </div>

            <button onclick="enterSelectMode()" id="mobileControls" class="hidden w-full md:w-auto bg-gray-800 text-white px-4 py-3 rounded-xl font-bold text-sm shadow hover:bg-gray-900 active:scale-95 transition flex items-center justify-center gap-2">
                <span>‚òëÔ∏è</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ
            </button>
        </div>

        <div id="content-watermark">
            <div id="grid-watermark" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 lg:gap-6 image-grid">
                {% for img in wm_images %}
                <div class="image-card bg-white p-2 rounded-xl shadow-sm border border-gray-100 relative group transition-all duration-300 hover:shadow-md">
                    <div class="selection-overlay hidden absolute inset-0 bg-black bg-opacity-5 z-10 rounded-xl flex items-start justify-end p-2 cursor-pointer" onclick="toggleCheckbox(this)">
                        <input type="checkbox" value="{{ img['secure_url'] }}" data-name="{{ img['public_id'].split('/')[-1] }}" onclick="event.stopPropagation(); updateCount();" class="custom-checkbox img-checkbox rounded-full shadow-md border-2 border-white bg-white">
                    </div>
                    <img src="{{ img['secure_url'] }}?t=1" crossorigin="anonymous" class="w-full h-40 lg:h-48 object-cover rounded-lg mb-2 bg-gray-200">
                    <p class="text-sm font-bold text-gray-800 truncate mb-1 name-label text-center">{{ img['public_id'].split('/')[-1] }}</p>
                    <a href="{{ img['secure_url'] }}" target="_blank" class="view-btn block w-full bg-blue-50 text-blue-600 text-center py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100">‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà</a>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="content-clean" class="hidden">
            <div id="grid-clean" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 lg:gap-6 image-grid">
                {% for img in cl_images %}
                <div class="image-card bg-white p-2 rounded-xl shadow-sm border border-gray-100 relative group transition-all duration-300 hover:shadow-md">
                    <div class="selection-overlay hidden absolute inset-0 bg-black bg-opacity-5 z-10 rounded-xl flex items-start justify-end p-2 cursor-pointer" onclick="toggleCheckbox(this)">
                        <input type="checkbox" value="{{ img['secure_url'] }}" data-name="{{ img['public_id'].split('/')[-1] }}" onclick="event.stopPropagation(); updateCount();" class="custom-checkbox img-checkbox rounded-full shadow-md border-2 border-white bg-white">
                    </div>
                    <img src="{{ img['secure_url'] }}?t=1" crossorigin="anonymous" class="w-full h-40 lg:h-48 object-cover rounded-lg mb-2 bg-gray-200">
                    <p class="text-sm font-bold text-gray-800 truncate mb-1 name-label text-center">{{ img['public_id'].split('/')[-1] }}</p>
                    <a href="{{ img['secure_url'] }}" target="_blank" class="view-btn block w-full bg-green-50 text-green-600 text-center py-1.5 rounded-lg text-xs font-bold hover:bg-green-100">‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="selectionBar" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-[0_-4px_15px_rgba(0,0,0,0.1)] p-4 z-40 slide-up rounded-t-2xl">
        <div class="max-w-xl mx-auto">
            <div class="flex items-center justify-between mb-3">
                <span class="text-gray-500 font-bold text-sm" id="selectionStatus">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß 0 ‡∏£‡∏π‡∏õ</span>
                <button onclick="toggleSelectAll()" class="text-blue-600 text-sm font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div class="flex gap-3">
                <button onclick="exitSelectMode()" class="bg-gray-100 text-gray-600 px-4 py-3 rounded-xl font-bold w-1/3 hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="startProcessing()" id="sendBtn" class="bg-blue-600 text-white px-4 py-3 rounded-xl font-bold w-2/3 shadow-lg hover:bg-blue-700 active:scale-95 transition flex items-center justify-center gap-2">üì≤ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ (iPad ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ)
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        window.onload = function() {
            if (isTouchDevice) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô iPad/Mobile -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
                document.getElementById('mobileControls').classList.remove('hidden');
                document.getElementById('tutorialSingle').classList.remove('hidden');
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô PC (‡πÄ‡∏°‡∏≤‡∏™‡πå) -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î ZIP
                document.getElementById('pcControls').classList.remove('hidden');
                document.getElementById('pcControls').classList.add('flex');
            }
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        let currentTab = 'watermark'; let isSelectMode = false; let preparedFiles = [];
        
        function switchTab(tab) {
            currentTab = tab; if(isSelectMode) exitSelectMode();
            document.getElementById('content-watermark').classList.add('hidden'); document.getElementById('content-clean').classList.add('hidden');
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('btn-watermark').className = "flex-1 pb-3 text-center transition " + (tab === 'watermark' ? 'tab-active' : 'tab-inactive');
            document.getElementById('btn-clean').className = "flex-1 pb-3 text-center transition " + (tab === 'clean' ? 'tab-active' : 'tab-inactive');
            filterImages(); 
        }
        function filterImages() {
            let input = document.getElementById('searchInput').value.toLowerCase();
            let activeGridId = currentTab === 'watermark' ? 'grid-watermark' : 'grid-clean';
            let cards = document.getElementById(activeGridId).getElementsByClassName('image-card');
            for (let i = 0; i < cards.length; i++) {
                let name = cards[i].querySelector('.name-label').innerText.toLowerCase();
                cards[i].style.display = name.includes(input) ? "" : "none";
            }
        }

        // PC ZIP Function
        async function downloadZipCurrentTab() {
            let activeGridId = currentTab === 'watermark' ? 'grid-watermark' : 'grid-clean';
            let cards = Array.from(document.getElementById(activeGridId).getElementsByClassName('image-card')).filter(c => c.style.display !== 'none');
            if(cards.length === 0) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${cards.length} ‡∏£‡∏π‡∏õ ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå ZIP ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            const zip = new JSZip();
            const oldText = event.target.innerText; event.target.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î..."; event.target.disabled = true;
            try {
                for (let card of cards) {
                    let img = card.querySelector('img'); let name = card.querySelector('.name-label').innerText.trim() + ".jpg";
                    let res = await fetch(img.src); let blob = await res.blob(); zip.file(name, blob);
                }
                let content = await zip.generateAsync({type:"blob"});
                let zipName = currentTab === 'watermark' ? 'Menu_Watermarked.zip' : 'Menu_Original.zip';
                saveAs(content, zipName);
            } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); } finally { event.target.innerText = oldText; event.target.disabled = false; }
        }

        // Mobile/iPad Select Mode
        function enterSelectMode() {
            isSelectMode = true; document.getElementById('tutorialMulti').classList.remove('hidden');
            document.querySelectorAll('.selection-overlay').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.add('opacity-30', 'pointer-events-none'));
            document.getElementById('selectionBar').classList.remove('hidden'); 
            document.getElementById('mobileControls').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
            document.body.classList.add('pb-40');
        }
        function exitSelectMode() {
            isSelectMode = false; document.querySelectorAll('.selection-overlay').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('opacity-30', 'pointer-events-none'));
            document.getElementById('selectionBar').classList.add('hidden'); 
            document.getElementById('mobileControls').classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            document.body.classList.remove('pb-40'); uncheckAll();
        }
        function toggleCheckbox(overlay) { const checkbox = overlay.querySelector('input'); checkbox.checked = !checkbox.checked; updateCount(); }
        function getActiveCheckboxes() {
            let activeGridId = currentTab === 'watermark' ? 'grid-watermark' : 'grid-clean';
            return Array.from(document.getElementById(activeGridId).querySelectorAll('.img-checkbox')).filter(cb => cb.closest('.image-card').style.display !== 'none');
        }
        function toggleSelectAll() { const checkboxes = getActiveCheckboxes(); const allChecked = checkboxes.every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !allChecked); updateCount(); }
        function uncheckAll() { document.querySelectorAll('.img-checkbox').forEach(cb => cb.checked = false); updateCount(); }
        function updateCount() {
            const count = getActiveCheckboxes().filter(cb => cb.checked).length;
            document.getElementById('selectionStatus').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${count} ‡∏£‡∏π‡∏õ`;
            const btn = document.getElementById('sendBtn');
            if(count > 0) { btn.classList.remove('opacity-50', 'cursor-not-allowed'); btn.disabled = false; } 
            else { btn.classList.add('opacity-50', 'cursor-not-allowed'); btn.disabled = true; }
        }

        async function startProcessing() {
            const checkboxes = getActiveCheckboxes(); let targets = checkboxes.filter(cb => cb.checked); if (targets.length === 0) return;
            const modal = document.getElementById('processingModal'); const loadingState = document.getElementById('stateLoading');
            const readyState = document.getElementById('stateReady'); const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            modal.classList.remove('hidden'); loadingState.classList.remove('hidden'); readyState.classList.add('hidden');
            progressBar.style.width = '0%'; preparedFiles = [];
            try {
                for (let i = 0; i < targets.length; i++) {
                    const cb = targets[i]; const percent = Math.round(((i + 1) / targets.length) * 100);
                    progressBar.style.width = percent + '%'; progressText.innerText = `${i + 1} / ${targets.length}`;
                    const url = cb.value + "?t=" + new Date().getTime(); const name = cb.getAttribute('data-name') + ".jpg";
                    const res = await fetch(url); const blob = await res.blob(); const file = new File([blob], name, { type: "image/jpeg" });
                    preparedFiles.push(file);
                }
                setTimeout(() => { loadingState.classList.add('hidden'); readyState.classList.remove('hidden'); readyState.classList.add('fade-in'); }, 500);
            } catch (error) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); closeProcessing(); }
        }
        async function triggerShare() {
            if (preparedFiles.length > 0 && navigator.canShare && navigator.canShare({ files: preparedFiles })) {
                try { await navigator.share({ files: preparedFiles, title: '‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏ô‡∏π' }); closeProcessing(); exitSelectMode(); } catch (error) { console.log(error); }
            } else {
                alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏£‡∏á (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô PC) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô ZIP ‡πÅ‡∏ó‡∏ô");
                const zip = new JSZip(); preparedFiles.forEach(f => zip.file(f.name, f));
                const content = await zip.generateAsync({type:"blob"}); saveAs(content, "Menu.zip"); closeProcessing(); exitSelectMode();
            }
        }
        function closeProcessing() { document.getElementById('processingModal').classList.add('hidden'); }
    </script>
</body>
</html>

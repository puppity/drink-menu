<!DOCTYPE html>
<html>
<head>
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-4 font-sans text-gray-800">
    <div class="max-w-4xl mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-gear"></i> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ</h1>
            <a href="/" class="bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 text-sm font-bold shadow-sm transition">
                <i class="fa-solid fa-arrow-left"></i> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
            </a>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm mb-8 border border-gray-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up text-blue-600"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
            </h2>
            
            <div id="uploadForm">
                <div class="mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <label class="block mb-2 text-sm font-bold text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô:</label>
                    <div class="flex gap-6">
                        <label class="flex items-center cursor-pointer hover:text-blue-600 transition">
                            <input type="radio" name="type" value="watermarked" checked class="w-5 h-5 text-blue-600 accent-blue-600">
                            <span class="ml-2 font-medium">üíß ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:text-green-600 transition">
                            <input type="radio" name="type" value="clean" class="w-5 h-5 text-green-600 accent-green-600">
                            <span class="ml-2 font-medium">‚ú® ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-sm font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (Option):</label>
                        <input type="text" id="customName" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏à‡∏∞‡∏ó‡∏±‡∏ö)">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ):</label>
                        <input type="file" id="fileInput" multiple accept="image/*" class="w-full p-2 border rounded-xl bg-gray-50">
                    </div>
                </div>

                <button onclick="startQueueUpload()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg active:scale-95 transition">
                    üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                </button>
            </div>

            <div id="progressArea" class="hidden mt-6">
                <div class="flex justify-between text-sm font-bold mb-1">
                    <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                    <div id="progressBar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="logArea" class="h-32 overflow-y-auto bg-gray-900 text-green-400 p-3 rounded-xl text-xs font-mono border border-gray-700"></div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
            <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-images"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="relative w-full md:w-1/2">
                <input type="text" id="searchInput" onkeyup="searchImages()" 
                       placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                       class="w-full pl-10 pr-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div id="imageList" class="divide-y divide-gray-100">
                {% for img in images %}
                <div class="image-item flex items-center justify-between p-4 hover:bg-gray-50 transition group" 
                     data-name="{{ img['public_id'] }}">
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="relative w-16 h-16 flex-shrink-0">
                            <img src="{{ img['secure_url'] }}" class="w-full h-full object-cover rounded-lg border bg-gray-100 img-preview">
                        </div>
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-800 text-sm break-all">
                                {{ img['public_id'].split('/')[-1] }}
                            </span>
                            <span class="text-xs text-gray-500 mt-1">
                                {% if 'watermarked' in img['public_id'] %}
                                    <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">üíß ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</span>
                                {% else %}
                                    <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚ú® ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</span>
                                {% endif %}
                                <span class="ml-2 text-gray-400">{{ img['created_at'][:10] }}</span>
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openReplaceModal('{{ img['public_id'] }}')" 
                                class="bg-yellow-50 text-yellow-600 border border-yellow-200 px-3 py-2 rounded-lg text-sm font-bold hover:bg-yellow-100 transition flex items-center gap-1">
                            <i class="fa-solid fa-rotate"></i> <span class="hidden md:inline">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà/‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠</span>
                        </button>
                        <a href="/delete/{{ img['public_id'] }}" 
                           onclick="return confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')"
                           class="bg-red-50 text-red-600 border border-red-200 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition flex items-center gap-1">
                           <i class="fa-solid fa-trash"></i> <span class="hidden md:inline">‡∏•‡∏ö</span>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div id="noResult" class="hidden p-10 text-center text-gray-400">
                <i class="fa-regular fa-face-frown text-4xl mb-2"></i>
                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
            </div>
        </div>
    </div>

    <div id="replaceModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl scale-up-center">
            <h3 class="text-lg font-bold mb-2 text-gray-800">üîÑ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
            <p class="text-sm text-gray-500 mb-4">
                ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°: <b id="targetName" class="text-blue-600 break-all">...</b>
            </p>
            
            <label class="block text-sm font-bold mb-2 text-gray-700">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà:</label>
            <input type="file" id="replaceFile" accept="image/*" class="w-full mb-4 text-sm text-gray-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-50 file:text-blue-700
              hover:file:bg-blue-100">

            <label class="block text-sm font-bold mb-2 text-gray-700">2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£):</label>
            <input type="text" id="replaceNewName" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà" 
                   class="w-full p-2 border rounded-lg mb-6 bg-gray-50 text-sm focus:ring-2 focus:ring-blue-500">
            
            <div class="flex gap-3">
                <button onclick="closeReplaceModal()" class="flex-1 py-2 rounded-xl text-gray-500 font-bold hover:bg-gray-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmReplace()" id="confirmReplaceBtn" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold hover:bg-blue-700 shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        // --- Search ---
        function searchImages() {
            let input = document.getElementById('searchInput').value.toLowerCase();
            let items = document.getElementsByClassName('image-item');
            let visibleCount = 0;
            for (let i = 0; i < items.length; i++) {
                let name = items[i].getAttribute('data-name').toLowerCase();
                if (name.includes(input)) { items[i].style.display = ""; visibleCount++; } 
                else { items[i].style.display = "none"; }
            }
            document.getElementById('noResult').style.display = (visibleCount === 0) ? "block" : "none";
        }

        // --- Replace Logic ---
        let currentTargetId = '';

        function openReplaceModal(publicId) {
            currentTargetId = publicId;
            document.getElementById('targetName').innerText = publicId.split('/').pop();
            document.getElementById('replaceModal').classList.remove('hidden');
            document.getElementById('replaceFile').value = '';
            document.getElementById('replaceNewName').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠
        }

        function closeReplaceModal() {
            document.getElementById('replaceModal').classList.add('hidden');
        }

        async function confirmReplace() {
            const fileInput = document.getElementById('replaceFile');
            const newNameInput = document.getElementById('replaceNewName');
            
            if (fileInput.files.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");

            const btn = document.getElementById('confirmReplaceBtn');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('public_id', currentTargetId);
            formData.append('new_name', newNameInput.value); // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

            try {
                const res = await fetch('/replace_image', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'success') {
                    alert("‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    window.location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                closeReplaceModal();
            }
        }

        // --- Queue Upload (Logic ‡πÄ‡∏î‡∏¥‡∏°) ---
        let fileQueue = [], totalFiles = 0, successCount = 0, failCount = 0, activeUploads = 0;
        const CONCURRENCY_LIMIT = 2;

        function log(msg, type='info') {
            const area = document.getElementById('logArea');
            const color = type === 'error' ? 'text-red-400' : 'text-green-400';
            area.innerHTML += `<div class="${color}">> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function startQueueUpload() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            document.getElementById('uploadForm').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('progressArea').classList.remove('hidden');
            document.getElementById('logArea').innerHTML = '';
            fileQueue = Array.from(files); totalFiles = fileQueue.length; successCount = 0; failCount = 0;
            log(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß ${totalFiles} ‡∏£‡∏π‡∏õ...`);
            for (let i = 0; i < CONCURRENCY_LIMIT; i++) processNextInQueue();
        }

        function processNextInQueue() {
            if (fileQueue.length === 0 && activeUploads === 0) { finishUpload(); return; }
            if (fileQueue.length === 0) return;
            const file = fileQueue.shift();
            const index = totalFiles - fileQueue.length;
            activeUploads++;
            uploadSingleFile(file, index).then(() => {
                activeUploads--; updateProgress(); processNextInQueue();
            });
        }

        async function uploadSingleFile(file, index) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', document.querySelector('input[name="type"]:checked').value);
            formData.append('name', document.getElementById('customName').value);
            formData.append('index', index);
            try {
                log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á: ${file.name}...`);
                const response = await fetch('/upload_api', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'success') { successCount++; log(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${result.file}`); } 
                else { throw new Error(result.message); }
            } catch (error) { failCount++; log(`‚ùå ‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error'); }
        }

        function updateProgress() {
            const processed = successCount + failCount;
            const percent = Math.round((processed / totalFiles) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('percentText').innerText = percent + '%';
            document.getElementById('statusText').innerText = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} | ‡∏û‡∏•‡∏≤‡∏î ${failCount}`;
        }

        function finishUpload() {
            log('üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...', 'info');
            setTimeout(() => window.location.reload(), 1500);
        }
    </script>
</body>
</html>

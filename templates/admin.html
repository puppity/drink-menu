<!DOCTYPE html>
<html>
<head>
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-5 font-sans">
    <div class="max-w-3xl mx-auto">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h1>
            <a href="/" class="text-blue-600 underline text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß </h2>
            
            <div id="uploadForm">
                <div class="mb-4 bg-gray-50 p-3 rounded border">
                    <label class="block mb-2 text-sm font-bold text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="type" value="watermarked" checked class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm">‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="type" value="clean" class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm">‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-sm font-bold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ):</label>
                        <input type="text" id="customName" class="w-full p-2 border rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°)">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞ 100 ‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢):</label>
                        <input type="file" id="fileInput" multiple accept="image/*" class="w-full p-2 border rounded bg-gray-50">
                    </div>
                </div>

                <button onclick="startQueueUpload()" id="startBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow transition">
                    üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                </button>
            </div>

            <div id="progressArea" class="hidden mt-6">
                <div class="flex justify-between text-sm font-bold mb-1">
                    <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden">
                    <div id="progressBar" class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <div id="logArea" class="h-40 overflow-y-auto bg-gray-900 text-green-400 p-3 rounded text-xs font-mono border border-gray-700">
                    <p class="text-gray-500">Waiting to start...</p>
                </div>
            </div>
        </div>

        <h2 class="text-lg font-bold mb-3 text-gray-700">üìÇ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            {% for img in images %}
            <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                <div class="flex items-center gap-3 overflow-hidden">
                    <img src="{{ img['secure_url'] }}" class="w-12 h-12 object-cover rounded bg-gray-200">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium text-gray-700 truncate w-40">
                            {{ img['public_id'].split('/')[-1] }}
                        </span>
                        <span class="text-xs text-gray-400">
                            {{ 'üíß ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥' if 'watermarked' in img['public_id'] else '‚ú® ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö' }}
                        </span>
                    </div>
                </div>
                <a href="/delete/{{ img['public_id'] }}" 
                   onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ?')"
                   class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-200">
                   ‡∏•‡∏ö
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        let fileQueue = [];
        let totalFiles = 0;
        let successCount = 0;
        let failCount = 0;
        let isUploading = false;
        
        // üî• Config: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (2 ‡∏£‡∏π‡∏õ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Server ‡∏ü‡∏£‡∏µ)
        const CONCURRENCY_LIMIT = 2; 
        let activeUploads = 0;

        function log(msg, type='info') {
            const area = document.getElementById('logArea');
            const color = type === 'error' ? 'text-red-400' : 'text-green-400';
            area.innerHTML += `<div class="${color}">> ${msg}</div>`;
            area.scrollTop = area.scrollHeight; // Auto scroll
        }

        function startQueueUpload() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            document.getElementById('uploadForm').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('progressArea').classList.remove('hidden');
            document.getElementById('logArea').innerHTML = ''; // Clear log

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß
            fileQueue = Array.from(files);
            totalFiles = fileQueue.length;
            successCount = 0;
            failCount = 0;
            
            log(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß... ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalFiles} ‡∏£‡∏π‡∏õ`);
            log(`‡∏à‡∏∞‡∏ó‡∏¢‡∏≠‡∏¢‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏•‡∏∞ ${CONCURRENCY_LIMIT} ‡∏£‡∏π‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏≠‡∏° Server`);

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢ Worker ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Limit
            for (let i = 0; i < CONCURRENCY_LIMIT; i++) {
                processNextInQueue();
            }
        }

        function processNextInQueue() {
            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á -> ‡∏à‡∏ö
            if (fileQueue.length === 0 && activeUploads === 0) {
                finishUpload();
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏î ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà -> ‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏ö
            if (fileQueue.length === 0) return;

            // ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß
            const file = fileQueue.shift();
            const index = totalFiles - fileQueue.length; // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏π‡∏õ
            activeUploads++;

            uploadSingleFile(file, index).then(() => {
                activeUploads--;
                updateProgress();
                processNextInQueue(); // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏´‡∏¢‡∏¥‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏≥
            });
        }

        async function uploadSingleFile(file, index) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', document.querySelector('input[name="type"]:checked').value);
            formData.append('name', document.getElementById('customName').value);
            formData.append('index', index);

            try {
                log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á: ${file.name}...`);
                
                const response = await fetch('/upload_api', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    successCount++;
                    log(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${result.file}`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                failCount++;
                log(`‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${file.name}): ${error.message}`, 'error');
            }
        }

        function updateProgress() {
            const processed = successCount + failCount;
            const percent = Math.round((processed / totalFiles) * 100);
            
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('percentText').innerText = percent + '%';
            document.getElementById('statusText').innerText = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} | ‡∏û‡∏•‡∏≤‡∏î ${failCount} (‡∏à‡∏≤‡∏Å ${totalFiles})`;
        }

        function finishUpload() {
            document.getElementById('progressBar').classList.replace('bg-green-500', 'bg-blue-500');
            log('üéâ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    </script>
</body>
</html>
